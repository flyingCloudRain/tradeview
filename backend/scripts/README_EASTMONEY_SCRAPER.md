# 东方财富网营业部历史交易明细抓取测试

## 测试结果总结

### 测试URL
https://data.eastmoney.com/stock/lhb/yyb/10000399618.html

### 测试营业部
- **营业部ID**: 10000399618
- **营业部名称**: 高盛(中国)证券有限责任公司上海浦东新区世纪大道证券营业部

## 测试方法对比

### 方法1: HTML页面抓取 ❌
- **状态**: 失败
- **原因**: 数据通过JavaScript动态加载，直接抓取HTML无法获取数据
- **结果**: 表格结构存在但数据为空

### 方法2: 直接API调用 ❌
- **状态**: 失败
- **原因**: 无法找到正确的API端点和报表名称
- **尝试的API**:
  - `datacenter-web.eastmoney.com/api/data/v1/get` (多个报表名称均失败)
  - `push2.eastmoney.com/api/qt/clist/get` (返回了龙虎榜列表数据，但不是营业部历史明细)

### 方法3: 使用AKShare库 ✅ (推荐)
- **状态**: 成功
- **接口**: `ak.stock_lhb_yyb_detail_em(symbol='10000399618')`
- **结果**: 
  - 成功获取 **4216条** 历史交易明细数据
  - 包含19个字段：序号、营业部代码、营业部名称、交易日期、股票代码、股票名称、涨跌幅、买入金额、卖出金额、净额、上榜原因、以及1/2/3/5/10/20/30日后涨跌幅等

## 使用方法

### 1. 使用AKShare库（推荐）

```python
import akshare as ak
import pandas as pd

# 营业部ID
branch_id = "10000399618"

# 获取营业部历史交易明细
df = ak.stock_lhb_yyb_detail_em(symbol=branch_id)

# 查看数据
print(f"数据形状: {df.shape}")
print(df.head())

# 保存到CSV
df.to_csv('yyb_detail.csv', index=False, encoding='utf-8-sig')
```

### 2. 运行测试脚本

```bash
cd backend
python scripts/test_eastmoney_scraper.py
```

脚本会：
1. 尝试HTML抓取
2. 尝试直接API调用
3. 使用AKShare库获取数据（推荐方法）
4. 保存结果到JSON和CSV文件

## 数据字段说明

获取的数据包含以下字段：

1. **序号** - 记录序号
2. **营业部代码** - 营业部唯一标识
3. **营业部名称** - 营业部全称
4. **营业部简称** - 营业部简称
5. **交易日期** - 交易发生日期
6. **股票代码** - 股票代码
7. **股票名称** - 股票名称
8. **涨跌幅** - 当日涨跌幅(%)
9. **买入金额** - 买入金额(万元)
10. **卖出金额** - 卖出金额(万元)
11. **净额** - 净买入/卖出额(万元)
12. **上榜原因** - 上榜原因
13. **1日后涨跌幅** - 上榜后1日涨跌幅(%)
14. **2日后涨跌幅** - 上榜后2日涨跌幅(%)
15. **3日后涨跌幅** - 上榜后3日涨跌幅(%)
16. **5日后涨跌幅** - 上榜后5日涨跌幅(%)
17. **10日后涨跌幅** - 上榜后10日涨跌幅(%)
18. **20日后涨跌幅** - 上榜后20日涨跌幅(%)
19. **30日后涨跌幅** - 上榜后30日涨跌幅(%)

## 输出文件

测试脚本会生成以下文件：

1. `branch_data_10000399618.json` - 抓取结果汇总（JSON格式）
2. `pei hi` - 完整的历史交易明细数据（CSV格式）

## 注意事项

1. **AKShare库**: 需要安装 `akshare` 库
2. **网络连接**: 需要能够访问东方财富网
3. **数据延迟**: AKShare接口可能需要一些时间获取数据（约1分钟）
4. **营业部ID**: 可以通过 `ak.stock_lhb_hyyyb_em()` 获取活跃营业部列表，从中找到营业部ID

## 相关文件

- `test_eastmoney_scraper.py` - 综合测试脚本
- `test_eastmoney_api_direct.py` - 直接API测试脚本
- `test_akshare_yyb_detail.py` - AKShare接口测试脚本

## 结论

**推荐使用方法3（AKShare库）**，这是最可靠和最简单的方法。AKShare已经封装了东方财富网的API调用，可以直接获取营业部历史交易明细数据。
