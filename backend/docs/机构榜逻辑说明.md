# 机构榜逻辑说明

## 概述

机构榜（龙虎榜机构榜）用于展示龙虎榜中机构/营业部的交易明细，包括买入/卖出金额、股票信息等。

## 数据模型

### 1. LhbInstitution（机构明细表）
**表名**: `lhb_institution`

**字段说明**:
- `id`: 主键
- `lhb_detail_id`: 关联到 `lhb_detail.id`（外键）
- `date`: 交易日期（索引）
- `stock_code`: 股票代码（索引）
- `institution_name`: 机构/营业部名称
- `buy_amount`: 买入金额（Numeric(15, 2)）
- `sell_amount`: 卖出金额（Numeric(15, 2)）
- `net_buy_amount`: 净买入金额（Numeric(15, 2)）
- `flag`: 交易方向（"买入"/"卖出"，索引）

**关系**:
- 多对一关联 `LhbDetail`（通过 `lhb_detail_id`）

### 2. LhbHotInstitution（机构游资榜聚合表）
**表名**: `lhb_hot_institution`

**字段说明**:
- `id`: 主键
- `date`: 上榜日期（索引）
- `institution_name`: 营业部名称（索引）
- `institution_code`: 营业部代码（索引，可选）
- `buy_stock_count`: 买入个股数
- `sell_stock_count`: 卖出个股数
- `buy_amount`: 买入总金额（Numeric(18, 2)）
- `sell_amount`: 卖出总金额（Numeric(18, 2)）
- `net_amount`: 总买卖净额（Numeric(18, 2)）
- `buy_stocks`: 买入股票列表（Text，空格分隔的股票名称）

**用途**: 按机构名称聚合统计，展示每个机构在指定日期的总体交易情况

## API 接口

### GET /api/v1/lhb/institution

**功能**: 获取机构榜列表（直接从 `lhb_institution` 表查询）

**参数**:
- `date` (可选): 日期，格式 YYYY-MM-DD；为空时返回最近一次同步的数据
- `page` (默认1): 页码
- `page_size` (默认20): 每页数量
- `sort_by` (可选): 排序字段，默认按 `buy_amount`/`sell_amount`
- `order` (默认desc): 排序方向 asc/desc
- `flag` (可选): 操作方向过滤（"买入"/"卖出"）
- `stock_name` (可选): 股票名称模糊查询
- `stock_code` (可选): 股票代码精确查询

**返回**: `LhbHotListResponse`
```json
{
  "items": [
    {
      "id": 1,
      "date": "2026-01-09",
      "institution_name": "机构名称",
      "stock_code": "000001",
      "stock_name": "股票名称",
      "flag": "买入",
      "buy_amount": 1000000.00,
      "sell_amount": 0.00,
      "net_buy_amount": 1000000.00
    }
  ],
  "total": 100,
  "page": 1,
  "page_size": 20,
  "total_pages": 5
}
```

### GET /api/v1/lhb/institution/{institution_code}/detail

**功能**: 获取营业部买入/卖出股票明细（即时调用 akshare API，不落库）

**参数**:
- `institution_code`: 营业部代码（路径参数）
- `date` (可选): 日期过滤，格式 YYYY-MM-DD

**返回**: `List[LhbHotInstitutionDetailResponse]`
```json
[
  {
    "date": "2026-01-09",
    "stock_code": "000001",
    "stock_name": "股票名称",
    "change_percent": 10.0,
    "buy_amount": 1000000.00,
    "sell_amount": 0.00,
    "net_amount": 1000000.00,
    "reason": "涨幅偏离值达7%",
    "after_1d": 2.5,
    "after_2d": 3.2,
    ...
  }
]
```

## 核心逻辑流程

### 1. 查询机构榜列表（LhbHotService.get_list）

**流程**:
1. **日期处理**:
   - 如果未指定日期，查询 `lhb_institution` 表的最大日期作为目标日期
   - 如果表中无数据，返回空列表

2. **基础查询**:
   ```python
   query = db.query(LhbInstitution).options(
       joinedload(LhbInstitution.lhb_detail)  # 预加载关联，避免N+1查询
   ).filter(LhbInstitution.date == target_date)
   ```

3. **过滤条件**:
   - `flag`: 按交易方向过滤（买入/卖出）
   - `stock_code`: 精确匹配股票代码
   - `stock_name`: 通过 JOIN `lhb_detail` 表进行模糊查询

4. **排序逻辑**:
   - 如果指定 `sort_by`:
     - 字段映射：`net_amount` → `net_buy_amount`，`amount` → `buy_amount`
     - 按指定字段排序（desc/asc）
   - 默认排序：
     - 先按日期倒序
     - 再按买入金额倒序（null值排最后）
     - 再按卖出金额倒序（null值排最后）

5. **分页**:
   - 计算总数：`total = query.count()`
   - 分页查询：`query.offset(offset).limit(page_size).all()`

6. **数据转换**:
   - 从 `LhbInstitution` 转换为 `LhbInstitutionItemResponse`
   - 通过 `lhb_detail` 关联获取股票名称
   - 将 Decimal 类型转换为 float（处理 inf、NaN 等异常值）

### 2. 同步机构榜数据（LhbHotService.sync_data）

**功能**: 从 `lhb_institution` 表聚合数据，生成 `lhb_hot_institution` 表记录

**流程**:
1. **查询指定日期的所有机构明细**:
   ```python
   institutions = db.query(LhbInstitution).options(
       joinedload(LhbInstitution.lhb_detail)
   ).filter(LhbInstitution.date == target_date).all()
   ```

2. **按机构名称分组聚合**:
   ```python
   institution_stats = {}
   for inst in institutions:
       inst_name = inst.institution_name
       if inst.flag == "买入":
           stats["buy_stocks"].add(inst.stock_code)
           stats["buy_amount"] += inst.buy_amount
           # 记录股票名称
           if inst.lhb_detail:
               stats["buy_stock_names"].append(inst.lhb_detail.stock_name)
       elif inst.flag == "卖出":
           stats["sell_stocks"].add(inst.stock_code)
           stats["sell_amount"] += inst.sell_amount
   ```

3. **计算统计指标**:
   - `buy_stock_count`: 买入股票数量（去重）
   - `sell_stock_count`: 卖出股票数量（去重）
   - `buy_amount`: 买入总金额
   - `sell_amount`: 卖出总金额
   - `net_amount`: 净额 = buy_amount - sell_amount
   - `buy_stocks`: 买入股票名称列表（空格分隔）

4. **查找机构代码映射**:
   - 从 `TraderBranch` 表查询机构代码映射
   - 匹配机构名称获取对应的 `institution_code`

5. **保存或更新**:
   - 检查是否已存在（按 date + institution_name）
   - 存在则更新，不存在则创建新记录

### 3. 获取营业部明细（LhbHotService.get_institution_detail）

**功能**: 实时调用 akshare API 获取营业部历史交易明细

**流程**:
1. **调用 akshare API**:
   ```python
   df = ak.stock_lhb_yyb_detail_em(symbol=institution_code)
   ```

2. **数据标准化**:
   - 重命名列：中文列名 → 英文列名
   - 日期转换：字符串 → date 对象
   - 日期过滤（如果指定）

3. **转换为响应对象**:
   - 包含交易日期、股票信息、金额、涨跌幅、后续表现等

## 数据流向

```
龙虎榜基础数据 (akshare)
    ↓
LhbDetail (龙虎榜详情表)
    ↓
LhbInstitution (机构明细表) ← 直接查询用于机构榜列表
    ↓
LhbHotInstitution (机构聚合表) ← 聚合统计用于机构游资榜
```

## 关键设计点

1. **双重数据源**:
   - `lhb_institution`: 明细数据，用于展示每只股票的机构交易
   - `lhb_hot_institution`: 聚合数据，用于展示每个机构的总体统计

2. **关联查询优化**:
   - 使用 `joinedload` 预加载 `lhb_detail`，避免 N+1 查询问题
   - 通过关联表获取股票名称，而不是冗余存储

3. **灵活查询**:
   - 支持按日期、股票、机构、方向等多维度过滤
   - 支持自定义排序字段和方向

4. **实时数据**:
   - 营业部明细通过 akshare API 实时获取，不落库
   - 包含后续涨跌幅等动态数据

5. **数据安全**:
   - Decimal 转 float 时处理异常值（inf、NaN）
   - 空值处理（None → None）

## 使用示例

### 查询某日所有买入机构
```python
GET /api/v1/lhb/institution?date=2026-01-09&flag=买入&sort_by=buy_amount&order=desc
```

### 查询某股票的机构交易
```python
GET /api/v1/lhb/institution?date=2026-01-09&stock_code=000001
```

### 查询某机构的详细历史
```python
GET /api/v1/lhb/institution/10050001/detail?date=2026-01-09
```

## 注意事项

1. **日期处理**: 如果不指定日期，会自动使用最新日期，确保数据可用性
2. **性能优化**: 使用索引字段（date、stock_code、flag）进行过滤，提高查询效率
3. **数据一致性**: 机构明细数据需要先同步龙虎榜基础数据才能使用
4. **聚合同步**: `lhb_hot_institution` 表需要通过 `sync_data` 方法定期同步更新
