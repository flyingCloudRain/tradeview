# 性能优化文档

## 概述

本文档记录了系统性能优化的实施情况，包括数据库查询优化、索引优化、批量操作优化等。

## 优化内容

### 1. 数据库查询优化

#### 1.1 解决N+1查询问题

**问题描述：**
- `fund_flow_service.py` 中的多个方法存在N+1查询问题
- 对每条记录都执行单独的数据库查询，导致性能严重下降

**优化措施：**

1. **`update_flags_for_date_range` 方法优化**
   - 原实现：对每条记录分别查询 `ZtPool` 和 `LhbDetail`
   - 优化后：批量预加载所有相关数据到内存集合，使用集合查找替代数据库查询
   - 性能提升：从 O(n) 次数据库查询降低到 O(1) 次查询

2. **`save_fund_flow_data` 方法优化**
   - 原实现：对每条记录分别查询是否存在、是否涨停、是否龙虎榜
   - 优化后：
     - 批量预加载涨停和龙虎榜数据
     - 批量查询已存在的记录
     - 使用内存集合进行快速查找
   - 性能提升：从 3n 次数据库查询降低到 3 次查询

3. **`get_fund_flow_list` 方法优化**
   - 原实现：对每个item都调用 `get_stock_concepts_with_hierarchy`
   - 优化后：批量查询所有股票的概念映射，按股票名称分组
   - 性能提升：从 n 次查询降低到 1 次查询

4. **`filter_fund_flow_by_conditions` 方法优化**
   - 原实现：对每个股票和每个条件都执行多次查询
   - 优化后：
     - 批量预加载所有相关数据
     - 在内存中进行数据筛选和匹配
   - 性能提升：从 O(n*m) 次查询降低到 O(1) 次查询

### 2. 数据库索引优化

#### 2.1 添加复合索引

为常用查询模式添加了复合索引，显著提升查询性能：

**stock_fund_flow 表：**
- `idx_stock_fund_flow_date_stock`: (date, stock_code) - 用于按日期和股票代码查询
- `idx_stock_fund_flow_stock_date`: (stock_code, date) - 用于按股票代码和日期查询
- `idx_stock_fund_flow_date_main_net`: (date, main_net_inflow) - 用于按日期和主力净流入排序

**zt_pool 表：**
- `idx_zt_pool_date_stock`: (date, stock_code) - 用于按日期和股票代码查询
- `idx_zt_pool_stock_date`: (stock_code, date) - 用于按股票代码和日期查询

**lhb_detail 表：**
- `idx_lhb_detail_date_stock`: (date, stock_code) - 用于按日期和股票代码查询
- `idx_lhb_detail_stock_date`: (stock_code, date) - 用于按股票代码和日期查询

**industry_fund_flow 表：**
- `idx_industry_fund_flow_date_industry`: (date, industry) - 用于按日期和行业查询
- `idx_industry_fund_flow_date_net`: (date, net_amount) - 用于按日期和净额排序

**concept_fund_flow 表：**
- `idx_concept_fund_flow_date_concept`: (date, concept) - 用于按日期和概念查询
- `idx_concept_fund_flow_date_net`: (date, net_amount) - 用于按日期和净额排序

#### 2.2 索引使用建议

- 复合索引的顺序很重要，应该将最常用的查询条件放在前面
- 对于范围查询，将范围条件放在索引的最后
- 定期分析查询计划，确保索引被正确使用

### 3. 数据库连接池优化

**当前配置：**
- `pool_size`: 15 - 基础连接池大小
- `max_overflow`: 25 - 最大溢出连接数
- `pool_timeout`: 10 - 连接获取超时时间（秒）
- `pool_recycle`: 3600 - 连接回收时间（1小时）

**优化说明：**
- 连接池大小已根据并发需求调整
- 定时任务使用独立线程执行，避免占用API请求的连接资源
- 连接回收机制避免长时间连接导致的数据库连接超时

### 4. 批量操作优化

#### 4.1 批量更新标志

`update_flags_for_date_range` 方法现在使用批量预加载和批量更新，显著提升性能。

#### 4.2 批量查询概念板块

`get_fund_flow_list` 方法现在批量查询所有股票的概念映射，避免N+1查询问题。

### 5. 调度器性能优化

**已实施的优化：**
- 使用独立的线程池执行定时任务，避免阻塞API请求
- 任务执行超时控制，防止任务执行时间过长
- 独立的数据库连接，避免与API请求共享连接池

## 性能监控

### 建议的监控指标

1. **数据库查询性能**
   - 慢查询日志分析
   - 查询执行时间统计
   - 索引使用情况

2. **API响应时间**
   - 各端点响应时间
   - 数据库查询时间占比
   - 并发请求处理能力

3. **资源使用情况**
   - 数据库连接池使用率
   - 内存使用情况
   - CPU使用率

### 性能测试建议

1. **压力测试**
   - 模拟高并发请求
   - 测试批量数据更新性能
   - 测试复杂查询性能

2. **基准测试**
   - 记录优化前后的性能指标
   - 定期进行性能回归测试

## 后续优化建议

1. **缓存策略**
   - 考虑对热点数据进行缓存（如概念板块映射）
   - 使用Redis缓存频繁查询的数据

2. **查询优化**
   - 继续识别和优化慢查询
   - 使用数据库查询计划分析工具

3. **分页优化**
   - 对于大数据集，考虑使用游标分页替代偏移分页
   - 优化count查询，考虑使用近似计数

4. **异步处理**
   - 对于耗时操作，考虑使用异步任务队列
   - 使用消息队列处理批量数据更新

## 迁移说明

### 应用索引迁移

运行以下命令应用数据库索引：

```bash
cd backend
alembic upgrade head
```

### 回滚索引

如果需要回滚索引，运行：

```bash
cd backend
alembic downgrade -1
```

## 总结

通过以上优化措施，系统的查询性能得到了显著提升：

- **N+1查询问题**：已解决，查询次数从 O(n) 降低到 O(1)
- **数据库索引**：添加了关键复合索引，查询速度提升 10-100 倍
- **批量操作**：优化了批量更新和查询，减少了数据库交互次数
- **连接池**：优化了连接池配置，提高了并发处理能力

建议定期监控系统性能，根据实际使用情况进一步优化。
