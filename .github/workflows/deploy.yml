name: Deploy to CloudBase

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

env:
  NODE_VERSION: '18'
  PYTHON_VERSION: '3.9'

jobs:
  deploy:
    name: Deploy to CloudBase
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Python Dependencies
        working-directory: ./backend
        run: |
          echo "å®‰è£… Python ä¾èµ–..."
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: Install CloudBase CLI
        run: |
          npm install -g @cloudbase/cli

      - name: Configure CloudBase Authentication
        run: |
          echo "é…ç½® CloudBase è®¤è¯..."
          mkdir -p ~/.tcb
          
          # ä½¿ç”¨è‡ªå®šä¹‰ç™»å½•å¯†é’¥ï¼ˆæ¨èæ–¹å¼ï¼‰
          if [ -n "$CLOUDBASE_PRIVATE_KEY" ] && [ -n "$CLOUDBASE_ENV_ID" ]; then
            echo "ä½¿ç”¨è‡ªå®šä¹‰ç™»å½•å¯†é’¥..."
            # ä½¿ç”¨ Python åˆ›å»º JSON æ–‡ä»¶ï¼ˆæ­£ç¡®å¤„ç†æ¢è¡Œç¬¦ï¼‰
            python3 << 'PYTHONEOF'
          import json
          import os
          
          key_data = {
            "private_key_id": os.environ.get("CLOUDBASE_PRIVATE_KEY_ID", ""),
            "private_key": os.environ.get("CLOUDBASE_PRIVATE_KEY", "").replace("\\n", "\n"),
            "env_id": os.environ.get("CLOUDBASE_ENV_ID", "")
          }
          
          os.makedirs(os.path.expanduser("~/.tcb"), exist_ok=True)
          key_file = os.path.expanduser("~/.tcb/custom_login_key.json")
          with open(key_file, "w") as f:
            json.dump(key_data, f, indent=2)
          
          print(f"âœ… è‡ªå®šä¹‰å¯†é’¥æ–‡ä»¶å·²åˆ›å»º: {key_file}")
          PYTHONEOF
            # ä½¿ç”¨è‡ªå®šä¹‰å¯†é’¥ç™»å½•
            echo "å°è¯•ä½¿ç”¨è‡ªå®šä¹‰å¯†é’¥ç™»å½•..."
            cloudbase login --key ~/.tcb/custom_login_key.json || {
              echo "âš ï¸  è‡ªå®šä¹‰å¯†é’¥ç™»å½•å¤±è´¥ï¼Œå°è¯•å…¶ä»–æ–¹å¼..."
            }
          fi
          
          # å¤‡ç”¨æ–¹æ¡ˆï¼šä½¿ç”¨ SecretId å’Œ SecretKey
          if [ -n "$TCB_SECRET_ID" ] && [ -n "$TCB_SECRET_KEY" ]; then
            echo "ä½¿ç”¨ SecretId/SecretKey ç™»å½•..."
            python3 << 'PYTHONEOF'
          import json
          import os
          
          login_data = {
            "secretId": os.environ.get("TCB_SECRET_ID", ""),
            "secretKey": os.environ.get("TCB_SECRET_KEY", "")
          }
          
          os.makedirs(os.path.expanduser("~/.tcb"), exist_ok=True)
          login_file = os.path.expanduser("~/.tcb/login.json")
          with open(login_file, "w") as f:
            json.dump(login_data, f, indent=2)
          
          print(f"âœ… ç™»å½•é…ç½®æ–‡ä»¶å·²åˆ›å»º: {login_file}")
          PYTHONEOF
            cloudbase login --key ~/.tcb/login.json || echo "ç™»å½•æ–¹å¼éœ€è¦è°ƒæ•´"
          fi
          
          # éªŒè¯ç™»å½•çŠ¶æ€
          echo "éªŒè¯ CloudBase ç™»å½•çŠ¶æ€..."
          cloudbase env:list || echo "âš ï¸  ç™»å½•éªŒè¯å¤±è´¥ï¼Œè¯·æ£€æŸ¥å¯†é’¥é…ç½®"
        env:
          CLOUDBASE_ENV_ID: ${{ secrets.CLOUDBASE_ENV_ID }}
          CLOUDBASE_PRIVATE_KEY_ID: ${{ secrets.CLOUDBASE_PRIVATE_KEY_ID }}
          CLOUDBASE_PRIVATE_KEY: ${{ secrets.CLOUDBASE_PRIVATE_KEY }}
          TCB_SECRET_ID: ${{ secrets.TCB_SECRET_ID }}
          TCB_SECRET_KEY: ${{ secrets.TCB_SECRET_KEY }}

      - name: Run Database Migrations
        working-directory: ./backend
        run: |
          echo "=========================================="
          echo "è¿è¡Œæ•°æ®åº“è¿ç§»"
          echo "=========================================="
          
          if [ -z "$DATABASE_URL" ]; then
            echo "âš ï¸  è­¦å‘Š: DATABASE_URL æœªè®¾ç½®ï¼Œè·³è¿‡æ•°æ®åº“è¿ç§»"
            echo "è¯·åœ¨ GitHub Secrets ä¸­é…ç½® DATABASE_URL"
            echo "æ ¼å¼: postgresql://postgres:[PASSWORD]@db.[PROJECT-REF].supabase.co:5432/postgres"
            exit 0
          fi
          
          echo "æ•°æ®åº“è¿æ¥: ${DATABASE_URL%%@*}@***"  # éšè—å¯†ç 
          
          echo ""
          echo "æ£€æŸ¥å½“å‰æ•°æ®åº“ç‰ˆæœ¬..."
          alembic current || echo "æ•°æ®åº“å¯èƒ½å°šæœªåˆå§‹åŒ–"
          
          echo ""
          echo "æ‰§è¡Œæ•°æ®åº“è¿ç§»..."
          alembic upgrade head
          
          echo ""
          echo "éªŒè¯è¿ç§»ç»“æœ..."
          alembic current
          
          echo ""
          echo "âœ… æ•°æ®åº“è¿ç§»å®Œæˆ"
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        continue-on-error: false  # è¿ç§»å¤±è´¥åˆ™åœæ­¢éƒ¨ç½²

      - name: Build Frontend
        working-directory: ./frontend
        run: |
          npm ci
          npm run build

      - name: Prepare Backend for Deployment
        run: |
          echo "å‡†å¤‡åç«¯ä»£ç ..."
          mkdir -p functions/trading-api
          cp backend/index.py functions/trading-api/
          cp backend/requirements.txt functions/trading-api/
          cp -r backend/app functions/trading-api/
          
          # ç¡®ä¿ mangum åœ¨ requirements.txt ä¸­
          if ! grep -q "mangum" functions/trading-api/requirements.txt; then
            echo "mangum>=0.17.0" >> functions/trading-api/requirements.txt
          fi

      - name: Deploy Cloud Function
        run: |
          echo "éƒ¨ç½²äº‘å‡½æ•°..."
          ENV_ID="${{ secrets.CLOUDBASE_ENV_ID }}"
          if [ -z "$ENV_ID" ]; then
            echo "é”™è¯¯: CLOUDBASE_ENV_ID æœªè®¾ç½®"
            exit 1
          fi
          cloudbase functions:deploy trading-api -e "$ENV_ID" --force
        env:
          CLOUDBASE_ENV_ID: ${{ secrets.CLOUDBASE_ENV_ID }}

      - name: Deploy Static Website
        run: |
          echo "éƒ¨ç½²é™æ€ç½‘ç«™..."
          ENV_ID="${{ secrets.CLOUDBASE_ENV_ID }}"
          if [ -z "$ENV_ID" ]; then
            echo "é”™è¯¯: CLOUDBASE_ENV_ID æœªè®¾ç½®"
            exit 1
          fi
          cloudbase hosting:deploy frontend/dist -e "$ENV_ID"
        env:
          CLOUDBASE_ENV_ID: ${{ secrets.CLOUDBASE_ENV_ID }}

      - name: Deployment Summary
        run: |
          echo "## ğŸš€ éƒ¨ç½²å®Œæˆ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ç¯å¢ƒ ID**: ${{ secrets.CLOUDBASE_ENV_ID }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**æ•°æ®åº“è¿ç§»**: $([ -n '${{ secrets.DATABASE_URL }}' ] && echo 'âœ… å·²æ‰§è¡Œ' || echo 'âš ï¸  æœªé…ç½® DATABASE_URL')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**è®¿é—®åœ°å€**:">> $GITHUB_STEP_SUMMARY
          echo "- å‰ç«¯: https://${{ secrets.CLOUDBASE_ENV_ID }}.tcloudbaseapp.com" >> $GITHUB_STEP_SUMMARY
          echo "- API: https://${{ secrets.CLOUDBASE_ENV_ID }}.ap-shanghai.app.tcloudbase.com/trading-api/api/v1" >> $GITHUB_STEP_SUMMARY
