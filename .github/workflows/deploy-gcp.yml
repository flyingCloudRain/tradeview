name: Deploy to Google Cloud Platform

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:
    inputs:
      deploy_backend:
        description: 'Deploy Backend'
        required: false
        default: true
        type: boolean
      deploy_frontend:
        description: 'Deploy Frontend'
        required: false
        default: true
        type: boolean

env:
  GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  GCP_REGION: ${{ secrets.GCP_REGION || 'us-central1' }}
  FUNCTION_NAME: ${{ secrets.FUNCTION_NAME || 'trading-api' }}
  FRONTEND_SERVICE_NAME: ${{ secrets.FRONTEND_SERVICE_NAME || 'trading-frontend' }}

jobs:
  deploy-backend:
    name: Deploy Backend to Cloud Functions
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')) ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.deploy_backend == 'true')
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure gcloud
        run: |
          gcloud config set project ${{ env.GCP_PROJECT_ID }}
          gcloud config set compute/region ${{ env.GCP_REGION }}

      - name: Install Python dependencies
        working-directory: ./backend
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          echo "âœ… Python dependencies installed successfully"
          pip list | grep -E "(fastapi|mangum|functions-framework)" || echo "âš ï¸ Warning: Some dependencies may not be installed"

      - name: Run database migrations (optional)
        working-directory: ./backend
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          if [ -z "$DATABASE_URL" ]; then
            echo "âš ï¸ DATABASE_URL not set, skipping database migrations"
            exit 0
          fi
          
          if command -v alembic &> /dev/null || python -m alembic --help &> /dev/null; then
            echo "Running database migrations..."
            alembic upgrade head || python -m alembic upgrade head
            echo "âœ… Database migrations completed"
          else
            echo "âš ï¸ Alembic not found, skipping migrations"
          fi

      - name: Verify deployment files
        working-directory: ./backend
        run: |
          echo "Checking deployment files..."
          ls -la main.py || echo "âŒ main.py not found"
          ls -la app/main.py || echo "âŒ app/main.py not found"
          ls -la requirements.txt || echo "âŒ requirements.txt not found"
          echo "âœ… File check complete"

      - name: Deploy to Cloud Functions
        working-directory: ./backend
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
          CORS_ORIGINS: ${{ secrets.CORS_ORIGINS }}
        run: |
          set -e  # Exit on error
          
          # Verify main.py exists and has main function
          echo "Verifying main.py..."
          if [ ! -f "main.py" ]; then
            echo "âŒ Error: main.py not found!"
            exit 1
          fi
          
          # Check if main function exists (basic check)
          if ! grep -q "def main" main.py; then
            echo "âŒ Error: main function not found in main.py!"
            exit 1
          fi
          
          echo "âœ… main.py verified"
          
          # Check if function is currently deploying and wait if needed
          echo "Checking function deployment status..."
          FUNCTION_STATE=$(gcloud functions describe ${{ env.FUNCTION_NAME }} \
            --gen2 \
            --region=${{ env.GCP_REGION }} \
            --project=${{ env.GCP_PROJECT_ID }} \
            --format="value(state)" 2>/dev/null || echo "NOT_FOUND")
          
          if [ "$FUNCTION_STATE" = "DEPLOYING" ]; then
            echo "âš ï¸  Function is currently deploying. Waiting for it to complete..."
            MAX_WAIT=600  # 10 minutes max wait
            WAIT_TIME=0
            while [ $WAIT_TIME -lt $MAX_WAIT ]; do
              FUNCTION_STATE=$(gcloud functions describe ${{ env.FUNCTION_NAME }} \
                --gen2 \
                --region=${{ env.GCP_REGION }} \
                --project=${{ env.GCP_PROJECT_ID }} \
                --format="value(state)" 2>/dev/null || echo "NOT_FOUND")
              
              if [ "$FUNCTION_STATE" != "DEPLOYING" ]; then
                echo "âœ… Previous deployment completed. State: $FUNCTION_STATE"
                break
              fi
              
              echo "Still deploying... (waited ${WAIT_TIME}s)"
              sleep 10
              WAIT_TIME=$((WAIT_TIME + 10))
            done
            
            if [ "$FUNCTION_STATE" = "DEPLOYING" ]; then
              echo "âš ï¸  Previous deployment still in progress after ${MAX_WAIT}s. Proceeding anyway..."
            fi
          else
            echo "Function state: $FUNCTION_STATE"
          fi
          
          # Prepare environment variables
          ENV_VARS=""
          [ -n "$DATABASE_URL" ] && ENV_VARS="$ENV_VARS,DATABASE_URL=$DATABASE_URL"
          [ -n "$SUPABASE_URL" ] && ENV_VARS="$ENV_VARS,SUPABASE_URL=$SUPABASE_URL"
          [ -n "$SUPABASE_KEY" ] && ENV_VARS="$ENV_VARS,SUPABASE_KEY=$SUPABASE_KEY"
          [ -n "$SUPABASE_SERVICE_KEY" ] && ENV_VARS="$ENV_VARS,SUPABASE_SERVICE_KEY=$SUPABASE_SERVICE_KEY"
          [ -n "$CORS_ORIGINS" ] && ENV_VARS="$ENV_VARS,CORS_ORIGINS=$CORS_ORIGINS"
          
          # Remove leading comma
          ENV_VARS=${ENV_VARS#,}
          
          echo "=========================================="
          echo "Deploying Cloud Function..."
          echo "Function: ${{ env.FUNCTION_NAME }}"
          echo "Region: ${{ env.GCP_REGION }}"
          echo "Entry Point: main"
          echo "Environment Variables: ${ENV_VARS:0:100}..." # Show first 100 chars
          echo "=========================================="
          
          # Build deployment command
          DEPLOY_CMD="gcloud functions deploy ${{ env.FUNCTION_NAME }} \
            --gen2 \
            --runtime=python311 \
            --region=${{ env.GCP_REGION }} \
            --source=. \
            --entry-point=main \
            --trigger-http \
            --allow-unauthenticated \
            --memory=512MB \
            --timeout=540s \
            --max-instances=10 \
            --service-account=${{ secrets.GCP_SA_EMAIL || '' }} \
            --min-instances=0 \
            --max-instances=10"
          
          # Add environment variables if present
          if [ -n "$ENV_VARS" ]; then
            DEPLOY_CMD="$DEPLOY_CMD --set-env-vars=\"$ENV_VARS\""
          fi
          
          echo "Executing deployment command..."
          echo "Command: $DEPLOY_CMD"
          
          # Execute deployment with retry logic for 409 conflicts
          MAX_RETRIES=3
          RETRY_COUNT=0
          DEPLOY_SUCCESS=false
          
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            # Capture both stdout and stderr
            if ERROR_OUTPUT=$(eval $DEPLOY_CMD 2>&1); then
              DEPLOY_SUCCESS=true
              echo "$ERROR_OUTPUT"
              break
            else
              EXIT_CODE=$?
              echo "$ERROR_OUTPUT"
              
              # Check if it's a 409 conflict error
              if echo "$ERROR_OUTPUT" | grep -q "409\|unable to queue the operation"; then
                RETRY_COUNT=$((RETRY_COUNT + 1))
                if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                  WAIT_TIME=$((RETRY_COUNT * 30))  # Exponential backoff: 30s, 60s
                  echo ""
                  echo "âš ï¸  Deployment conflict (409). Waiting ${WAIT_TIME}s before retry ${RETRY_COUNT}/${MAX_RETRIES}..."
                  sleep $WAIT_TIME
                  
                  # Check function state again
                  FUNCTION_STATE=$(gcloud functions describe ${{ env.FUNCTION_NAME }} \
                    --gen2 \
                    --region=${{ env.GCP_REGION }} \
                    --project=${{ env.GCP_PROJECT_ID }} \
                    --format="value(state)" 2>/dev/null || echo "NOT_FOUND")
                  echo "Current function state: $FUNCTION_STATE"
                  echo "Retrying deployment..."
                  continue
                else
                  echo ""
                  echo "âŒ Max retries reached. Previous deployment may still be in progress."
                  echo "Please wait a few minutes and try again, or check the function status:"
                  echo "  gcloud functions describe ${{ env.FUNCTION_NAME }} --gen2 --region=${{ env.GCP_REGION }}"
                fi
              fi
              
              # If not a 409 error, break and show error
              break
            fi
          done
          
          if [ "$DEPLOY_SUCCESS" = false ]; then
            echo "âŒ Deployment failed!"
            echo ""
            echo "=== Debugging Information ==="
            echo "1. Verifying gcloud authentication..."
            gcloud auth list || echo "âš ï¸ Authentication issue"
            echo ""
            echo "2. Checking required APIs..."
            gcloud services list --enabled --project=${{ env.GCP_PROJECT_ID }} --filter="name:cloudfunctions.googleapis.com OR name:cloudbuild.googleapis.com OR name:cloudresourcemanager.googleapis.com" || echo "âš ï¸ API check issue"
            echo ""
            echo "3. Checking Cloud Build logs..."
            echo "   Visit: https://console.cloud.google.com/cloud-build/builds?project=${{ env.GCP_PROJECT_ID }}"
            echo ""
            echo "4. Checking function status..."
            gcloud functions describe ${{ env.FUNCTION_NAME }} --gen2 --region=${{ env.GCP_REGION }} --project=${{ env.GCP_PROJECT_ID }} 2>&1 || echo "âš ï¸ Function does not exist yet"
            echo ""
            echo "5. If APIs are not enabled, enable them manually:"
            echo "   Visit: https://console.cloud.google.com/apis/library?project=${{ env.GCP_PROJECT_ID }}"
            echo "   Enable: Cloud Functions API, Cloud Build API, Cloud Resource Manager API"
            exit 1
          fi
          
          echo "âœ… Deployment command executed successfully"

      - name: Get Function URL
        id: function-url
        run: |
          FUNCTION_URL=$(gcloud functions describe ${{ env.FUNCTION_NAME }} \
            --gen2 \
            --region=${{ env.GCP_REGION }} \
            --format="value(serviceConfig.uri)" 2>/dev/null || echo "")
          echo "url=$FUNCTION_URL" >> $GITHUB_OUTPUT
          echo "âœ… Backend deployed successfully"
          echo "Function URL: $FUNCTION_URL"

      - name: Output deployment info
        run: |
          echo "## ðŸš€ Backend Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Function Name:** ${{ env.FUNCTION_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "**Region:** ${{ env.GCP_REGION }}" >> $GITHUB_STEP_SUMMARY
          echo "**URL:** ${{ steps.function-url.outputs.url }}" >> $GITHUB_STEP_SUMMARY

  deploy-frontend:
    name: Deploy Frontend to Cloud Run
    runs-on: ubuntu-latest
    needs: deploy-backend
    if: |
      (github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')) ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.deploy_frontend == 'true')
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure gcloud
        run: |
          gcloud config set project ${{ env.GCP_PROJECT_ID }}
          gcloud config set compute/region ${{ env.GCP_REGION }}

      - name: Grant required permissions to Cloud Build service account
        run: |
          echo "ä½¿ç”¨ github-actions-deployer æœåŠ¡è´¦å·æŽˆäºˆ Cloud Build æœåŠ¡è´¦å·å¿…è¦çš„æƒé™..."
          # èŽ·å– Cloud Build æœåŠ¡è´¦å·
          PROJECT_NUMBER=$(gcloud projects describe ${{ env.GCP_PROJECT_ID }} --format="value(projectNumber)")
          CLOUD_BUILD_SA="${PROJECT_NUMBER}@cloudbuild.gserviceaccount.com"
          GITHUB_SA="github-actions-deployer@${{ env.GCP_PROJECT_ID }}.iam.gserviceaccount.com"
          
          echo "GitHub Actions æœåŠ¡è´¦å·: $GITHUB_SA"
          echo "Cloud Build æœåŠ¡è´¦å·: $CLOUD_BUILD_SA"
          
          # æŽˆäºˆå¿…è¦çš„è§’è‰²ï¼ˆä½¿ç”¨å·²è®¤è¯çš„ github-actions-deployer æœåŠ¡è´¦å·ï¼‰
          gcloud projects add-iam-policy-binding ${{ env.GCP_PROJECT_ID }} \
            --member="serviceAccount:${CLOUD_BUILD_SA}" \
            --role="roles/serviceusage.serviceUsageConsumer" \
            --condition=None || echo "âš ï¸ æƒé™å¯èƒ½å·²å­˜åœ¨æˆ–éœ€è¦é¢å¤–æƒé™"
          
          gcloud projects add-iam-policy-binding ${{ env.GCP_PROJECT_ID }} \
            --member="serviceAccount:${CLOUD_BUILD_SA}" \
            --role="roles/run.admin" \
            --condition=None || echo "âš ï¸ æƒé™å¯èƒ½å·²å­˜åœ¨æˆ–éœ€è¦é¢å¤–æƒé™"
          
          gcloud projects add-iam-policy-binding ${{ env.GCP_PROJECT_ID }} \
            --member="serviceAccount:${CLOUD_BUILD_SA}" \
            --role="roles/iam.serviceAccountUser" \
            --condition=None || echo "âš ï¸ æƒé™å¯èƒ½å·²å­˜åœ¨æˆ–éœ€è¦é¢å¤–æƒé™"
          
          echo "âœ… æƒé™æŽˆäºˆå®Œæˆï¼ˆå¦‚æžœå¤±è´¥ï¼Œè¯·æ‰‹åŠ¨æŽˆäºˆæƒé™ï¼‰"

      - name: Get Backend API URL
        id: backend-url
        run: |
          API_URL=$(gcloud functions describe ${{ env.FUNCTION_NAME }} \
            --gen2 \
            --region=${{ env.GCP_REGION }} \
            --format="value(serviceConfig.uri)" 2>/dev/null || echo "")
          echo "url=$API_URL/api/v1" >> $GITHUB_OUTPUT
          echo "Backend API URL: $API_URL/api/v1"

      - name: Install frontend dependencies
        working-directory: ./frontend
        run: npm ci

      - name: Build frontend
        working-directory: ./frontend
        env:
          VITE_API_BASE_URL: ${{ steps.backend-url.outputs.url }}
        run: |
          echo "Building frontend with API URL: $VITE_API_BASE_URL"
          npm run build

      - name: Deploy to Cloud Run
        working-directory: ./frontend
        run: |
          echo "Deploying frontend to Cloud Run..."
          gcloud run deploy ${{ env.FRONTEND_SERVICE_NAME }} \
            --source=. \
            --platform=managed \
            --region=${{ env.GCP_REGION }} \
            --allow-unauthenticated \
            --port=80 \
            --memory=512Mi \
            --timeout=300

      - name: Get Frontend URL
        id: frontend-url
        run: |
          FRONTEND_URL=$(gcloud run services describe ${{ env.FRONTEND_SERVICE_NAME }} \
            --region=${{ env.GCP_REGION }} \
            --format="value(status.url)" 2>/dev/null || echo "")
          echo "url=$FRONTEND_URL" >> $GITHUB_OUTPUT
          echo "âœ… Frontend deployed successfully"
          echo "Frontend URL: $FRONTEND_URL"

      - name: Output deployment info
        run: |
          echo "## ðŸŽ¨ Frontend Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Service Name:** ${{ env.FRONTEND_SERVICE_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "**Region:** ${{ env.GCP_REGION }}" >> $GITHUB_STEP_SUMMARY
          echo "**URL:** ${{ steps.frontend-url.outputs.url }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Backend API URL:** ${{ steps.backend-url.outputs.url }}" >> $GITHUB_STEP_SUMMARY

  deployment-complete:
    name: Deployment Summary
    runs-on: ubuntu-latest
    needs: [deploy-backend, deploy-frontend]
    if: always()
    
    steps:
      - name: Deployment Summary
        run: |
          echo "## ðŸŽ‰ Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Backend" >> $GITHUB_STEP_SUMMARY
          echo "- Status: ${{ needs.deploy-backend.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Frontend" >> $GITHUB_STEP_SUMMARY
          echo "- Status: ${{ needs.deploy-frontend.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Next Steps:**" >> $GITHUB_STEP_SUMMARY
          echo "1. Verify backend API is accessible" >> $GITHUB_STEP_SUMMARY
          echo "2. Test frontend application" >> $GITHUB_STEP_SUMMARY
          echo "3. Check Cloud Functions logs for any errors" >> $GITHUB_STEP_SUMMARY
