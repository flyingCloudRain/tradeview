name: Deploy to Google Cloud Platform

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:
    inputs:
      deploy_backend:
        description: 'Deploy Backend'
        required: false
        default: 'true'
        type: boolean
      deploy_frontend:
        description: 'Deploy Frontend'
        required: false
        default: 'true'
        type: boolean

env:
  GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  GCP_REGION: ${{ secrets.GCP_REGION || 'us-central1' }}
  FUNCTION_NAME: ${{ secrets.FUNCTION_NAME || 'trading-api' }}
  FRONTEND_SERVICE_NAME: ${{ secrets.FRONTEND_SERVICE_NAME || 'trading-frontend' }}

jobs:
  deploy-backend:
    name: Deploy Backend to Cloud Functions
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')) ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.deploy_backend == 'true')
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure gcloud
        run: |
          gcloud config set project ${{ env.GCP_PROJECT_ID }}
          gcloud config set compute/region ${{ env.GCP_REGION }}

      - name: Install Python dependencies
        working-directory: ./backend
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run database migrations (optional)
        working-directory: ./backend
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          if [ -z "$DATABASE_URL" ]; then
            echo "âš ï¸ DATABASE_URL not set, skipping database migrations"
            exit 0
          fi
          
          if command -v alembic &> /dev/null || python -m alembic --help &> /dev/null; then
            echo "Running database migrations..."
            alembic upgrade head || python -m alembic upgrade head
            echo "âœ… Database migrations completed"
          else
            echo "âš ï¸ Alembic not found, skipping migrations"
          fi

      - name: Deploy to Cloud Functions
        working-directory: ./backend
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
          CORS_ORIGINS: ${{ secrets.CORS_ORIGINS }}
        run: |
          # Prepare environment variables
          ENV_VARS=""
          [ -n "$DATABASE_URL" ] && ENV_VARS="$ENV_VARS,DATABASE_URL=$DATABASE_URL"
          [ -n "$SUPABASE_URL" ] && ENV_VARS="$ENV_VARS,SUPABASE_URL=$SUPABASE_URL"
          [ -n "$SUPABASE_KEY" ] && ENV_VARS="$ENV_VARS,SUPABASE_KEY=$SUPABASE_KEY"
          [ -n "$SUPABASE_SERVICE_KEY" ] && ENV_VARS="$ENV_VARS,SUPABASE_SERVICE_KEY=$SUPABASE_SERVICE_KEY"
          [ -n "$CORS_ORIGINS" ] && ENV_VARS="$ENV_VARS,CORS_ORIGINS=$CORS_ORIGINS"
          
          # Remove leading comma
          ENV_VARS=${ENV_VARS#,}
          
          echo "Deploying Cloud Function..."
          echo "Function: ${{ env.FUNCTION_NAME }}"
          echo "Region: ${{ env.GCP_REGION }}"
          
          if [ -n "$ENV_VARS" ]; then
            gcloud functions deploy ${{ env.FUNCTION_NAME }} \
              --gen2 \
              --runtime=python311 \
              --region=${{ env.GCP_REGION }} \
              --source=. \
              --entry-point=main \
              --trigger-http \
              --allow-unauthenticated \
              --memory=512MB \
              --timeout=540s \
              --max-instances=10 \
              --set-env-vars="$ENV_VARS"
          else
            gcloud functions deploy ${{ env.FUNCTION_NAME }} \
              --gen2 \
              --runtime=python311 \
              --region=${{ env.GCP_REGION }} \
              --source=. \
              --entry-point=main \
              --trigger-http \
              --allow-unauthenticated \
              --memory=512MB \
              --timeout=540s \
              --max-instances=10
          fi

      - name: Get Function URL
        id: function-url
        run: |
          FUNCTION_URL=$(gcloud functions describe ${{ env.FUNCTION_NAME }} \
            --gen2 \
            --region=${{ env.GCP_REGION }} \
            --format="value(serviceConfig.uri)" 2>/dev/null || echo "")
          echo "url=$FUNCTION_URL" >> $GITHUB_OUTPUT
          echo "âœ… Backend deployed successfully"
          echo "Function URL: $FUNCTION_URL"

      - name: Output deployment info
        run: |
          echo "## ðŸš€ Backend Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Function Name:** ${{ env.FUNCTION_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "**Region:** ${{ env.GCP_REGION }}" >> $GITHUB_STEP_SUMMARY
          echo "**URL:** ${{ steps.function-url.outputs.url }}" >> $GITHUB_STEP_SUMMARY

  deploy-frontend:
    name: Deploy Frontend to Cloud Run
    runs-on: ubuntu-latest
    needs: deploy-backend
    if: |
      (github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')) ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.deploy_frontend == 'true')
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure gcloud
        run: |
          gcloud config set project ${{ env.GCP_PROJECT_ID }}
          gcloud config set compute/region ${{ env.GCP_REGION }}

      - name: Get Backend API URL
        id: backend-url
        run: |
          API_URL=$(gcloud functions describe ${{ env.FUNCTION_NAME }} \
            --gen2 \
            --region=${{ env.GCP_REGION }} \
            --format="value(serviceConfig.uri)" 2>/dev/null || echo "")
          echo "url=$API_URL/api/v1" >> $GITHUB_OUTPUT
          echo "Backend API URL: $API_URL/api/v1"

      - name: Install frontend dependencies
        working-directory: ./frontend
        run: npm ci

      - name: Build frontend
        working-directory: ./frontend
        env:
          VITE_API_BASE_URL: ${{ steps.backend-url.outputs.url }}
        run: |
          echo "Building frontend with API URL: $VITE_API_BASE_URL"
          npm run build

      - name: Deploy to Cloud Run
        working-directory: ./frontend
        run: |
          echo "Deploying frontend to Cloud Run..."
          gcloud run deploy ${{ env.FRONTEND_SERVICE_NAME }} \
            --source=. \
            --platform=managed \
            --region=${{ env.GCP_REGION }} \
            --allow-unauthenticated \
            --port=80 \
            --memory=512Mi \
            --timeout=300

      - name: Get Frontend URL
        id: frontend-url
        run: |
          FRONTEND_URL=$(gcloud run services describe ${{ env.FRONTEND_SERVICE_NAME }} \
            --region=${{ env.GCP_REGION }} \
            --format="value(status.url)" 2>/dev/null || echo "")
          echo "url=$FRONTEND_URL" >> $GITHUB_OUTPUT
          echo "âœ… Frontend deployed successfully"
          echo "Frontend URL: $FRONTEND_URL"

      - name: Output deployment info
        run: |
          echo "## ðŸŽ¨ Frontend Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Service Name:** ${{ env.FRONTEND_SERVICE_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "**Region:** ${{ env.GCP_REGION }}" >> $GITHUB_STEP_SUMMARY
          echo "**URL:** ${{ steps.frontend-url.outputs.url }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Backend API URL:** ${{ steps.backend-url.outputs.url }}" >> $GITHUB_STEP_SUMMARY

  deployment-complete:
    name: Deployment Summary
    runs-on: ubuntu-latest
    needs: [deploy-backend, deploy-frontend]
    if: always()
    
    steps:
      - name: Deployment Summary
        run: |
          echo "## ðŸŽ‰ Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Backend" >> $GITHUB_STEP_SUMMARY
          echo "- Status: ${{ needs.deploy-backend.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Frontend" >> $GITHUB_STEP_SUMMARY
          echo "- Status: ${{ needs.deploy-frontend.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Next Steps:**" >> $GITHUB_STEP_SUMMARY
          echo "1. Verify backend API is accessible" >> $GITHUB_STEP_SUMMARY
          echo "2. Test frontend application" >> $GITHUB_STEP_SUMMARY
          echo "3. Check Cloud Functions logs for any errors" >> $GITHUB_STEP_SUMMARY
